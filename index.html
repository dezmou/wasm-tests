<html>

<body>
  <script>

    (async () => {
      const img = await new Promise(resolve => {
        const img = new Image()
        img.src = "./image.png"
        img.onload = () => {
          resolve(img)
        }
      })
      const canvas = document.createElement("canvas")
      document.body.appendChild(canvas)
      canvas.width = img.width
      canvas.height = img.height
      const ctx = canvas.getContext("2d")
      ctx.drawImage(img, 0, 0)
      const pixels = ctx.getImageData(0, 0, img.width, img.height)

      const memory = new WebAssembly.Memory({ initial: 800, maximum: 8000 })
      console.log(memory);
      const chien = new Uint8Array(memory.buffer, 0, img.width * img.height * 4)
      chien.set(pixels.data, 0)

      const loadAsm = async (scriptSrc) => {
        const script = await (await fetch(scriptSrc)).arrayBuffer()
        const module = await WebAssembly.compile(script)

        const table = new WebAssembly.Table({ initial: 0, element: 'anyfunc' })
        const instance = new WebAssembly.Instance(module, {
          env: {
            memory,
          },
        })
        return instance.exports
      }

      const funcs = await loadAsm("main.wasm")

      while (true) {
        const time = performance.now();
        funcs.processImage(0, img.width, img.height)
        console.log(performance.now() - time);
        const dat = new ImageData(new Uint8ClampedArray(chien), img.width, img.height)
        ctx.putImageData(dat, 0, 0)
        await new Promise(r => requestAnimationFrame(r))
      }
    })()

  </script>
</body>

</html>